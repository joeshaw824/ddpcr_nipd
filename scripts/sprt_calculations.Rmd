---
title: '**SPRT Calculations**'
author: "Joe Shaw"
date: "29/09/2021"
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(tidyverse)
```

## Simplifying SPRT 

The SPRT calculations commonly used in relative mutation dosage are sourced from 
the supplementary material of Lo et al 2007 (PMID: 17664418).
The calculations can be accessed here (section: "Construction of SPRT Curves"):
<https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1934923/bin/pnas_0705765104_index.html>.

For an autosomal recessive condition, the q0 value is always 0.5. Consequently,
the calculations for the delta, gamma and likelihood ratio values can be
simplified.


```{r lr_functions, include=TRUE}
calc_lr <- function(fetal_fraction, overrep_fraction, total_copies) {
  q0 <- 0.5
  q1 <- 0.5+(fetal_fraction/2)
  delta <- (1- q1)/(1-q0)
  gamma <- ((q1 * (1-q0))/ (q0*(1-q1)))
  lr <- exp((((overrep_fraction*log(gamma)) + log(delta))*total_copies))
  return(lr)
}

calc_lr_new <- function(fetal_fraction, overrep_fraction, total_copies) {
  q1 <- 0.5+(fetal_fraction/2)
  delta <- 1 - fetal_fraction
  gamma <- (1 + fetal_fraction) / (1 - fetal_fraction)
  lr <- (gamma^overrep_fraction * delta)^total_copies
  return(lr)
}

```

## Testing the Simplification

By creating a random data-set of sensible input values, we can test if the
simplified function gives the same output as the original function.

```{r test_data, echo=TRUE}
test_data <- data.frame(
  fetal_fraction = sample(seq(from = 0.01, to = 0.15, by= 0.001), 20),
  overrep_fraction = sample(seq(from = 0.4, to = 0.6, by= 0.001), 20),
  total_copies = sample(seq(from = 100, to = 15000, by= 1), 20)) %>%
  
  mutate(
    lr_old = calc_lr(fetal_fraction, overrep_fraction, total_copies),
    lr_new = calc_lr_new(fetal_fraction, overrep_fraction, total_copies),
    difference = abs(lr_old - lr_new)) %>%
  
  select(lr_old, lr_new, difference)

test_data

```




